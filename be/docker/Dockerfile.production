FROM python:3.9

ENV PYTHONDONTWRITEBYTECODE 1
ENV PYTHONUNBUFFERED 1

ENV DJANGO_SETTINGS_MODULE osoc.settings.prod
ARG SECRET_KEY
ENV SECRET_KEY $SECRET_KEY
ARG DJANGO_SUPERUSER_EMAIL
ENV DJANGO_SUPERUSER_EMAIL $DJANGO_SUPERUSER_EMAIL
ARG DJANGO_SUPERUSER_PASSWORD
ENV DJANGO_SUPERUSER_PASSWORD $DJANGO_SUPERUSER_PASSWORD

ARG POSTGRES_USER
ENV POSTGRES_USER $POSTGRES_USER
ARG POSTGRES_PASSWORD
ENV POSTGRES_PASSWORD $POSTGRES_PASSWORD

COPY requirements.txt src/requirements.txt
WORKDIR /src

RUN pip install --upgrade pip && \
    pip install -r requirements.txt && \
    pip install gunicorn

CMD \
    chmod 755 ./docker/wait-for-it.sh && \
    ./docker/wait-for-it.sh -t 0 db:5432 --strict -- && \
    python manage.py migrate && \
    python manage.py collectstatic --noinput && \
    python scripts/create_superuser_production.py \
    && \
    gunicorn osoc.wsgi -b 0.0.0.0:8000 --access-logfile 'accesslogs' --error-logfile 'errorlogs'
